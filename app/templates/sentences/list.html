{% extends 'base.html' %}
{% block content %}
  <div class="card">
    <a href="/sentences/new">Dodaj nowe zdanie</a>
    <h1>Moje zdania</h1>
    <style>
      .card a {
          float: right;
      }
      .sentences-groups {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .sentences-group-row {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 1rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        border: 1px solid #e2e8f0;
      }
      .sentences-column ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .sentences-column li {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .sentence-text {
        flex: 1;
      }
      .audio-btn {
        background: #5f7ddc;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.5rem 0.6rem;
        cursor: pointer;
        font-size: 0.7rem;
      }
      .action-column {
        display: flex;
        flex-direction: column-reverse;
        align-items: flex-end;
        gap: 0.5rem;
        min-width: 140px;
      }
      .action-column button {
        padding: 0.5rem 0.6rem;
        font-size: 0.7rem;
      }
      .action-column .small {
        font-size: 0.85rem;
      }
    </style>
    <form method="get" class="filters">
      <div>
        <label for="source_language">Język źródłowy</label>
        <select id="source_language" name="source_language">
          <option value="">Wszystkie</option>
          {% for lang in languages %}
            <option value="{{ lang }}" {% if filters.source_language == lang %}selected{% endif %}>{{ lang|upper }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="q">Szukaj</label>
        <input id="q" name="q" placeholder="Fragment zdania" value="{{ filters.q or '' }}">
      </div>
      <div>
        <button type="submit">Filtruj</button>
      </div>
    </form>

    {% if sentences %}
      <div class="sentences-groups">
        {% for sentence in sentences %}
          <div class="sentences-group-row">
            <div class="sentences-column">
              <ul>
                <li>
                  <button type="button" class="audio-btn" data-url="{{ sentence.audio_url_source }}" data-lang="{{ sentence.source_language|upper }}">▶ {{ sentence.source_language|upper }}</button>
                  <span class="sentence-text">{{ sentence.source_text }}</span>
                </li>
                <li>
                  <button type="button" class="audio-btn" data-url="{{ sentence.audio_url_1 }}" data-lang="{{ sentence.target_language_1|upper }}">▶ {{ sentence.target_language_1|upper }}</button>
                  <span class="sentence-text">{{ sentence.translated_text_1 }}</span>
                </li>
                <li>
                  <button type="button" class="audio-btn" data-url="{{ sentence.audio_url_2 }}" data-lang="{{ sentence.target_language_2|upper }}">▶ {{ sentence.target_language_2|upper }}</button>
                  <span class="sentence-text">{{ sentence.translated_text_2 }}</span>
                </li>
              </ul>
              {% if current_user.is_admin %}
                <div class="muted small">
                  Providerzy (dla tego zdania):
                  tłumacz <strong>{{ (sentence.translation_provider or 'n/d')|upper }}</strong>,
                  TTS <strong>{{ (sentence.tts_provider or 'n/d')|upper }}</strong>
                  <br>
                  <span class="muted">Lektorzy: PL={{ sentence.tts_voice_source or 'domyślny' }}, {{ sentence.target_language_1|upper }}={{ sentence.tts_voice_1 or 'domyślny' }}, {{ sentence.target_language_2|upper }}={{ sentence.tts_voice_2 or 'domyślny' }}</span>
                </div>
              {% endif %}
            </div>
            <div class="action-column">
              <div class="muted small">{{ sentence.created_at.strftime('%Y-%m-%d %H:%M') if sentence.created_at else '' }}</div>
              <form method="post" action="{{ url_for('sentences.delete_sentence', sentence_id=sentence.id) }}" onsubmit="return confirm('Czy na pewno chcesz usunąć to zdanie?');">
                <button type="submit" class="delete-btn">Usuń</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">Brak zapisanych zdań. Dodaj pierwsze korzystając z przycisku w menu.</p>
    {% endif %}

    {% if pagination.pages > 1 %}
      <p class="muted" style="margin-top:1rem;">Strona {{ pagination.page }} z {{ pagination.pages }}</p>
    {% endif %}
  </div>
  <script>
    document.querySelectorAll('.sentences-group-row').forEach((row) => {
      let currentAudio = null;
      let currentButton = null;

      const updateLabel = (btn, playing) => {
        if (!btn) return;
        const lang = btn.dataset.lang || '';
        btn.textContent = `${playing ? '⏸' : '▶'} ${lang}`.trim();
      };

      row.querySelectorAll('.audio-btn').forEach((btn) => {
        updateLabel(btn, false);

        btn.addEventListener('click', () => {
          const url = btn.dataset.url;
          if (!url) {
            return;
          }
          if (currentAudio && !currentAudio.paused) {
            currentAudio.pause();
            updateLabel(currentButton, false);
            if (currentButton === btn) {
              currentAudio = null;
              currentButton = null;
              return;
            }
          }

          currentAudio = new Audio(url);
          currentButton = btn;
          updateLabel(btn, true);
          currentAudio.play().catch(() => updateLabel(btn, false));
          currentAudio.onended = () => {
            updateLabel(btn, false);
            currentAudio = null;
            currentButton = null;
          };
        });
      });
    });
  </script>
{% endblock %}
