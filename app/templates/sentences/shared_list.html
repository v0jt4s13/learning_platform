{% extends 'base.html' %}
{% block content %}
  <div class="card">
    <h1>Zdania wspólne</h1>
    <p class="muted">Zdania dostępne dla wszystkich użytkowników, pogrupowane według poziomu trudności.</p>
    <style>
      .sentences-groups { display: flex; flex-direction: column; gap: 1rem; }
      .sentences-group-row { display: flex; flex-direction: column; justify-content: space-between; gap: 1rem; background: #f8fafc; border-radius: 0.75rem; padding: 1rem 1.25rem; border: 1px solid #e2e8f0; }
      .sentences-column ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.4rem; }
      .sentences-column li { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
      .sentence-text { flex: 1; }
      .audio-btn { background: #5f7ddc; color: #fff; border: none; border-radius: 999px; padding: 0.5rem 0.6rem; cursor: pointer; font-size: 0.7rem; }
      .action-column { display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 0.5rem; min-width: 140px; }
      .action-column button { padding: 0.5rem 0.6rem; font-size: 0.7rem; }
      .action-column .small { font-size: 0.85rem; }
    </style>

    <form method="get" class="filters">
      <div>
        <label for="difficulty">Poziom</label>
        <select id="difficulty" name="difficulty">
          <option value="">Wszystkie</option>
          <option value="beginner" {% if filters.difficulty == 'beginner' %}selected{% endif %}>Beginner</option>
          <option value="intermediate" {% if filters.difficulty == 'intermediate' %}selected{% endif %}>Intermediate</option>
          <option value="advanced" {% if filters.difficulty == 'advanced' %}selected{% endif %}>Advanced</option>
        </select>
      </div>
      <div>
        <label for="q">Szukaj</label>
        <input id="q" name="q" placeholder="Fragment zdania" value="{{ filters.q or '' }}">
      </div>
      <div>
        <button type="submit">Filtruj</button>
      </div>
    </form>

    {% set has_any = false %}
    {% for level, sentences in grouped.items() %}
      {% if sentences %}
        {% set has_any = true %}
        <h2 style="margin-top:1rem;">{{ level|capitalize }}</h2>
        <div class="sentences-groups">
          {% for sentence in sentences %}
            <div class="sentences-group-row">
              <div class="sentences-column">
                <ul>
                  <li>
                    <button type="button" class="audio-btn" data-url="{{ sentence.audio_url_source }}" data-lang="{{ sentence.source_language|upper }}">▶ {{ sentence.source_language|upper }}</button>
                    <span class="sentence-text">{{ sentence.source_text }}</span>
                  </li>
                  {% if sentence.translated_text_1 %}
                    <li>
                      <button type="button" class="audio-btn" data-url="{{ sentence.audio_url_1 }}" data-lang="{{ sentence.target_language_1|upper }}">▶ {{ sentence.target_language_1|upper }}</button>
                      <span class="sentence-text">{{ sentence.translated_text_1 }}</span>
                    </li>
                  {% endif %}
                  {% if sentence.translated_text_2 %}
                    <li>
                      <button type="button" class="audio-btn" data-url="{{ sentence.audio_url_2 }}" data-lang="{{ sentence.target_language_2|upper }}">▶ {{ sentence.target_language_2|upper }}</button>
                      <span class="sentence-text">{{ sentence.translated_text_2 }}</span>
                    </li>
                  {% endif %}
                </ul>
              </div>
              <div class="action-column">
                <div class="muted small">{{ sentence.created_at.strftime('%Y-%m-%d %H:%M') if sentence.created_at else '' }}</div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}

    {% if not has_any %}
      <p class="muted">Brak udostępnionych zdań.</p>
    {% endif %}

    {% if pagination.pages > 1 %}
      <p class="muted" style="margin-top:1rem;">Strona {{ pagination.page }} z {{ pagination.pages }}</p>
    {% endif %}
  </div>
  <script>
    document.querySelectorAll('.sentences-group-row').forEach((row) => {
      let currentAudio = null;
      let currentButton = null;

      const updateLabel = (btn, playing) => {
        if (!btn) return;
        const lang = btn.dataset.lang || '';
        btn.textContent = `${playing ? '⏸' : '▶'} ${lang}`.trim();
      };

      row.querySelectorAll('.audio-btn').forEach((btn) => {
        updateLabel(btn, false);

        btn.addEventListener('click', () => {
          const url = btn.dataset.url;
          if (!url) {
            return;
          }
          if (currentAudio && !currentAudio.paused) {
            currentAudio.pause();
            updateLabel(currentButton, false);
            if (currentButton === btn) {
              currentAudio = null;
              currentButton = null;
              return;
            }
          }

          currentAudio = new Audio(url);
          currentButton = btn;
          updateLabel(btn, true);
          currentAudio.play().catch(() => updateLabel(btn, false));
          currentAudio.onended = () => {
            updateLabel(btn, false);
            currentAudio = null;
            currentButton = null;
          };
        });
      });
    });
  </script>
{% endblock %}
